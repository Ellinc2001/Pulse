<div class="mypulse-container">
  <div class="mypulse-content">
    <!-- Unified profile header with XP and level -->
    <header class="pulse-header">
      <div class="header-top">
        <div class="image-my-pulse"></div>
      </div>
      
      <div class="unified-profile-section">
        <div class="profile-left">
          <img src="https://i.pravatar.cc/150?img=47" alt="Profile" class="profile-image">
        </div>
        
        <div class="profile-center">
          <p class="profile-greeting">Ciao, Martina üëã</p>
          <!-- Put XP and level badges on the same row -->
          <div class="badges-row">
            <!-- Added xp-badge class for animation targeting -->
            <div class="xp-compact xp-badge" id="xp-badge">
              <ion-icon name="flash" class="xp-icon"></ion-icon>
              <span class="xp-value-compact">{{ currentXP }} XP</span>
            </div>
            <div class="level-badge">
              <span class="level-number">Lv.{{ currentLevel.number }}</span>
              <span class="level-name">{{ currentLevel.name }}</span>
            </div>
          </div>
          
          <div class="level-progress-section">
            <div class="level-progress-bar">
              <div class="level-progress-fill" [style.width.%]="levelProgress"></div>
            </div>
            <p class="level-progress-text" *ngIf="nextLevel">
              {{ xpToNextLevel }} XP to <strong>{{ nextLevel.name }}</strong>
            </p>
            <p class="level-progress-text" *ngIf="!nextLevel">
              <strong>Livello massimo raggiunto!</strong>
            </p>
          </div>
        </div>
      </div>
      
      <!-- Added test button for XP animation -->
      <button class="test-xp-button" (click)="testXpAnimation()">
        Test XP Animation
      </button>
    </header>

    <main class="main-content">
      <!-- New Progress block with Season -->
      <div class="progress-block">
        <!-- Season Card (visually strong) -->
        <div class="season-card">
          <div class="season-overlay">
            <p class="season-label">Season corrente</p>
            <h2 class="season-title">Winter Social ‚ùÑÔ∏è</h2>
            <div class="season-score-row">
              <span class="season-score-label">Season Score:</span>
              <span class="season-score-value">340</span>
            </div>
            <div class="season-progress-bar">
              <div class="season-progress-fill" [style.width]="'34%'"></div>
            </div>
            <p class="season-position">Sei tra i top 20% del tuo quartiere</p>
            
            <!-- Mini-challenges now inside season card as sublist -->
            <div class="mini-challenges-sublist">
              <div class="sublist-header">
                <ion-icon name="flash-outline" class="sublist-icon"></ion-icon>
                <h3 class="sublist-title">Mini-Challenges di questa Season</h3>
              </div>
              
              <div class="challenges-carousel">
                <!-- Each challenge card now has its own themed SVG background -->
                <div class="challenge-card">
                  <!-- SVG background: Snowflake -->
                  <svg class="challenge-bg-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <path d="M50 10 L50 90 M10 50 L90 50 M25 25 L75 75 M75 25 L25 75 M50 10 L35 25 M50 10 L65 25 M50 90 L35 75 M50 90 L65 75 M10 50 L25 35 M10 50 L25 65 M90 50 L75 35 M90 50 L75 65" 
                          stroke="currentColor" 
                          stroke-width="2" 
                          fill="none"/>
                  </svg>
                  <div class="challenge-header">
                    <h3 class="challenge-title">Frozen Friendships ‚ùÑÔ∏è</h3>
                    <span class="challenge-badge">+120 Score</span>
                  </div>
                  <p class="challenge-description">Partecipa a 4 eventi indoor invernali</p>
                  <div class="challenge-progress">
                    <div class="progress-bar-mini">
                      <div class="progress-fill-mini" [style.width]="'25%'"></div>
                    </div>
                    <span class="progress-text">1/4 completati</span>
                  </div>
                </div>
                
                <div class="challenge-card">
                  <!-- SVG background: Fire/Flame -->
                  <svg class="challenge-bg-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <path d="M50 20 Q40 35 45 50 Q35 55 40 70 Q45 85 50 90 Q55 85 60 70 Q65 55 55 50 Q60 35 50 20 Z" 
                          fill="currentColor"/>
                    <path d="M50 35 Q45 45 48 55 Q43 58 45 68 Q48 78 50 82 Q52 78 55 68 Q57 58 52 55 Q55 45 50 35 Z" 
                          fill="rgba(255,255,255,0.3)"/>
                  </svg>
                  <div class="challenge-header">
                    <h3 class="challenge-title">Cozy Connections üî•</h3>
                    <span class="challenge-badge">+80 Score</span>
                  </div>
                  <p class="challenge-description">Spark 5 nuovi utenti in luoghi caldi</p>
                  <div class="challenge-progress">
                    <div class="progress-bar-mini">
                      <div class="progress-fill-mini" [style.width]="'60%'"></div>
                    </div>
                    <span class="progress-text">3/5 completati</span>
                  </div>
                </div>
                
                <div class="challenge-card">
                  <!-- SVG background: Moon with stars -->
                  <svg class="challenge-bg-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="55" cy="45" r="25" fill="currentColor"/>
                    <circle cx="65" cy="40" r="20" fill="rgba(0,0,0,0.3)"/>
                    <path d="M20 20 L22 26 L28 28 L22 30 L20 36 L18 30 L12 28 L18 26 Z" fill="currentColor"/>
                    <path d="M75 65 L77 70 L82 72 L77 74 L75 79 L73 74 L68 72 L73 70 Z" fill="currentColor"/>
                    <path d="M30 70 L31 73 L34 74 L31 75 L30 78 L29 75 L26 74 L29 73 Z" fill="currentColor"/>
                  </svg>
                  <div class="challenge-header">
                    <h3 class="challenge-title">Winter Night Out üåô</h3>
                    <span class="challenge-badge">+100 Score</span>
                  </div>
                  <p class="challenge-description">Visita 3 eventi serali invernali</p>
                  <div class="challenge-progress">
                    <div class="progress-bar-mini">
                      <div class="progress-fill-mini" [style.width]="'33%'"></div>
                    </div>
                    <span class="progress-text">1/3 completati</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Enhanced pulse score section with more attractive design -->
      <div class="pulse-score-card">
        <div class="pulse-score-header">
          <div class="pulse-icon">
            <div class="pulse-dot"></div>
            <div class="pulse-ring"></div>
            <div class="pulse-ring-2"></div>
          </div>
          <h2 class="pulse-score-title">Pulse Score</h2>
        </div>
        <p class="pulse-score-number">12,580</p>
        <div class="pulse-score-footer">
          <div class="heartbeat-line">
            <svg viewBox="0 0 200 40" class="heartbeat-svg">
              <!-- Base line always visible -->
              <path d="M0,20 L200,20" 
                    stroke="currentColor" 
                    stroke-width="5" 
                    fill="none" 
                    class="heartbeat-base-line"/>
              <!-- Moving zigzag pattern -->
              <path d="M0,20 L40,20 L45,10 L50,30 L55,5 L60,35 L65,20 L105,20" 
                    stroke="currentColor" 
                    stroke-width="5" 
                    fill="none" 
                    class="heartbeat-zigzag"/>
            </svg>
          </div>
        </div>
      </div>

      <!-- Unified Events & Invites section with tab switcher -->
      <div class="events-invites-card">
        <!-- Tab switcher at the top -->
        <div class="events-toggle">
          <div class="events-slider" [style.transform]="eventsTab === 'invites' ? 'translateX(100%)' : 'translateX(0)'"></div>
          <button class="events-button" 
                  [class.active]="eventsTab === 'countdown'"
                  (click)="eventsTab = 'countdown'">
            Countdown
          </button>
          <button class="events-button"
                  [class.active]="eventsTab === 'invites'"
                  (click)="eventsTab = 'invites'">
            Inviti
          </button>
        </div>

        <!-- Countdown content -->
        <div class="events-content" *ngIf="eventsTab === 'countdown'">
          <div class="countdown-list">
            <!-- Updated to use displayedCountdownEvents and proper data binding -->
            <ng-container *ngFor="let event of displayedCountdownEvents; let last = last">
              <div class="countdown-card">
                <div class="countdown-icon">
                  <ion-icon class="event-icon" [name]="event.icon"></ion-icon>
                </div>
                <div class="countdown-info">
                  <p class="countdown-event-name">{{ event.name }}</p>
                  <p class="countdown-venue">{{ event.venue }}</p>
                </div>
                <div [class]="event.isUrgent ? 'countdown-badge-urgent' : 'countdown-badge'">
                  {{ event.countdown }}
                </div>
              </div>
              <div class="countdown-divider" *ngIf="!last"></div>
            </ng-container>
            
            <!-- Added "View all" link when there are more than 3 events -->
            <div class="view-all-link" *ngIf="hasMoreCountdownEvents" (click)="openAllCountdownEvents()">
              <span class="view-all-text">Vedi tutti ({{ countdownEvents.length }})</span>
              <ion-icon name="chevron-forward" class="view-all-icon"></ion-icon>
            </div>
          </div>
        </div>

        <!-- Invites content -->
        <div class="events-content" *ngIf="eventsTab === 'invites'">
          <div class="invites-list">
            <!-- Updated to use displayedInvites -->
            <ng-container *ngFor="let invite of displayedInvites; let last = last">
              <div class="invite-row" (click)="openInviteDetail(invite.id)">
                <div class="invite-avatar">
                  <img *ngIf="invite.avatarUrl" 
                       [src]="invite.avatarUrl" 
                       [alt]="invite.eventTitle"
                       class="invite-avatar-img">
                  <div *ngIf="!invite.avatarUrl && invite.avatarText" 
                       class="invite-avatar-text">
                    {{ invite.avatarText }}
                  </div>
                </div>
                <div class="invite-details">
                  <p class="invite-event-title">{{ invite.eventTitle }}</p>
                  <p class="invite-from">da {{ invite.fromUser }}</p>
                  <p class="invite-time">Venerdi ¬∑ tra 3 giorni</p>
                </div>
                <div class="invite-status-pill">
                  Nuovo
                </div>
              </div>
              <div class="countdown-divider" *ngIf="!last"></div>
            </ng-container>
            
            <!-- Added "View all" link when there are more than 3 invites -->
            <div class="view-all-link" *ngIf="hasMoreInvites" (click)="openAllInvites()">
              <span class="view-all-text">Vedi tutti ({{ invites.length }})</span>
              <ion-icon name="chevron-forward" class="view-all-icon"></ion-icon>
            </div>
          </div>
        </div>
      </div>

      <!-- Spark section with proper toggle -->
      <div class="spark-card">
        <h2 class="section-title">Spark</h2>
        <div class="spark-toggle">
          <div class="spark-slider" [style.transform]="sparkTab === 'mine' ? 'translateX(100%)' : 'translateX(0)'"></div>
          <button class="spark-button" 
                  [class.active]="sparkTab === 'me'"
                  (click)="sparkTab = 'me'">
            Sparked Me ({{ sparkMeUsers.length }})
          </button>
          <button class="spark-button"
                  [class.active]="sparkTab === 'mine'"
                  (click)="sparkTab = 'mine'">
            My Sparks ({{ mySparkUsers.length }})
          </button>
        </div>
        <!-- Updated to iterate over sparkMeUsers array and pass user data to openUserProfile -->
        <div class="spark-content" *ngIf="sparkTab === 'me'">
          <p class="spark-description">Persone che hanno lasciato uno spark</p>
          <div class="spark-avatars">
            <div class="spark-avatar-item" 
                 *ngFor="let user of sparkMeUsers"
                 (click)="openUserProfile(user)">
              <img class="spark-avatar" [src]="user.avatarUrl" [alt]="user.name">
            </div>
          </div>
        </div>
        <!-- Updated to iterate over mySparkUsers array and pass user data to openUserProfile -->
        <div class="spark-content" *ngIf="sparkTab === 'mine'">
          <p class="spark-description">Persone ai quali hai lasciato uno spark</p>
          <div class="spark-avatars">
            <div class="spark-avatar-item" 
                 *ngFor="let user of mySparkUsers"
                 (click)="openUserProfile(user)">
              <img class="spark-avatar" [src]="user.avatarUrl" [alt]="user.name">
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>
