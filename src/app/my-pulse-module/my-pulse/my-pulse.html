<div class="mypulse-container">
  <div class="mypulse-content">
    <!-- Unified profile header with XP and level -->
    <header class="pulse-header">
      <div class="header-top">
        <div class="image-my-pulse"></div>
      </div>
      
      <!-- New mesh gradient profile card -->
      <div class="profile-card-mesh">
        <!-- Abstract decorative lines -->
        <div class="abstract-lines">
          <div class="abstract-line line-1"></div>
          <div class="abstract-line line-2"></div>
          <div class="abstract-line line-3"></div>
        </div>
        
        <!-- Glow effects -->
        <div class="card-glow glow-purple"></div>
        <div class="card-glow glow-cyan"></div>
        
        <!-- Main content grid -->
        <div class="profile-grid">
          <!-- Avatar with animated glow ring -->
          <div class="avatar-glow-ring">
            <div class="avatar-inner">
              <img src="https://i.pravatar.cc/150?img=47" alt="Profile" class="avatar-image">
            </div>
          </div>
          
          <!-- Info section -->
          <div class="profile-info-section">
            <h2 class="greeting-text">Ciao, Martina</h2>
            
            <!-- Badges grid (2 columns) -->
            <div class="badges-grid">
              <!-- XP Badge -->
              <div class="xp-badge-new" id="xp-badge">
                <ion-icon name="bolt" class="xp-bolt-icon"></ion-icon>
                <span class="xp-value-new">{{ currentXP }}</span>
              </div>
              
              <!-- Level Badge -->
              <div class="level-badge-new">
                <span class="level-tag">LV.{{ currentLevel.number }}</span>
                <span class="level-name-new">{{ currentLevel.name }}</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Progress section at bottom -->
        <div class="next-goal-section">
          <div class="goal-info">
            <span class="goal-label">Next Goal</span>
            <span class="goal-name" *ngIf="nextLevel">{{ nextLevel.name }}</span>
            <span class="goal-name" *ngIf="!nextLevel">Max Level</span>
          </div>
          <div class="goal-progress">
            <span class="goal-percentage">{{ levelProgress }}%</span>
            <span class="goal-xp-left" *ngIf="nextLevel">{{ xpToNextLevel }} XP left</span>
          </div>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" [style.width.%]="levelProgress">
            <div class="progress-bar-glow"></div>
            <div class="progress-bar-edge"></div>
          </div>
        </div>
      </div>
      
      <!-- Added test button for XP animation -->
      <button class="test-xp-button" (click)="testXpAnimation()">
        Test XP Animation
      </button>
    </header>

    <!-- Added Sparks stats pills section -->
    <div class="sparks-stats-row">
      <div class="spark-stat-pill spark-received" (click)="openSparksModal('received')">
        <span class="spark-stat-emoji">üî•</span>
        <span class="spark-stat-text">Sparks ricevuti:</span>
        <span class="spark-stat-value received">{{ sparksReceived }}</span>
      </div>
      <div class="spark-stat-pill spark-given" (click)="openSparksModal('given')">
        <span class="spark-stat-emoji">‚ö°</span>
        <span class="spark-stat-text">Sparks dati:</span>
        <span class="spark-stat-value given">{{ sparksGiven }}</span>
      </div>
    </div>

    <main class="main-content">
      <!-- New Progress block with Season -->
      <div class="progress-block">
        <!-- Season Card (visually strong) -->
        <div class="season-card">
          <div class="season-overlay">
            <p class="season-label">Season corrente</p>
            <h2 class="season-title">Winter Social ‚ùÑÔ∏è</h2>
            <div class="season-score-row">
              <span class="season-score-label">Season Score:</span>
              <span class="season-score-value">340</span>
            </div>
            <div class="season-progress-bar">
              <div class="season-progress-fill" [style.width]="'34%'"></div>
            </div>
            <p class="season-position">Sei tra i top 20% del tuo quartiere</p>
            
            <!-- Mini-challenges now inside season card as sublist -->
            <div class="mini-challenges-sublist">
              <div class="sublist-header">
                <ion-icon name="flash-outline" class="sublist-icon"></ion-icon>
                <h3 class="sublist-title">Mini-Challenges di questa Season</h3>
              </div>
              
              <div class="challenges-carousel">
                <!-- Each challenge card now has its own themed SVG background -->
                <div class="challenge-card">
                  <!-- SVG background: Snowflake -->
                  <svg class="challenge-bg-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <path d="M50 10 L50 90 M10 50 L90 50 M25 25 L75 75 M75 25 L25 75 M50 10 L35 25 M50 10 L65 25 M50 90 L35 75 M50 90 L65 75 M10 50 L25 35 M10 50 L25 65 M90 50 L75 35 M90 50 L75 65" 
                          stroke="currentColor" 
                          stroke-width="2" 
                          fill="none"/>
                  </svg>
                  <div class="challenge-header">
                    <h3 class="challenge-title">Frozen Friendships ‚ùÑÔ∏è</h3>
                    <span class="challenge-badge">+120 Score</span>
                  </div>
                  <p class="challenge-description">Partecipa a 4 eventi indoor invernali</p>
                  <div class="challenge-progress">
                    <div class="progress-bar-mini">
                      <div class="progress-fill-mini" [style.width]="'25%'"></div>
                    </div>
                    <span class="progress-text">1/4 completati</span>
                  </div>
                </div>
                
                <div class="challenge-card">
                  <!-- SVG background: Fire/Flame -->
                  <svg class="challenge-bg-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <path d="M50 20 Q40 35 45 50 Q35 55 40 70 Q45 85 50 90 Q55 85 60 70 Q65 55 55 50 Q60 35 50 20 Z" 
                          fill="currentColor"/>
                    <path d="M50 35 Q45 45 48 55 Q43 58 45 68 Q48 78 50 82 Q52 78 55 68 Q57 58 52 55 Q55 45 50 35 Z" 
                          fill="rgba(255,255,255,0.3)"/>
                  </svg>
                  <div class="challenge-header">
                    <h3 class="challenge-title">Cozy Connections üî•</h3>
                    <span class="challenge-badge">+80 Score</span>
                  </div>
                  <p class="challenge-description">Spark 5 nuovi utenti in luoghi caldi</p>
                  <div class="challenge-progress">
                    <div class="progress-bar-mini">
                      <div class="progress-fill-mini" [style.width]="'60%'"></div>
                    </div>
                    <span class="progress-text">3/5 completati</span>
                  </div>
                </div>
                
                <div class="challenge-card">
                  <!-- SVG background: Moon with stars -->
                  <svg class="challenge-bg-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="55" cy="45" r="25" fill="currentColor"/>
                    <circle cx="65" cy="40" r="20" fill="rgba(0,0,0,0.3)"/>
                    <path d="M20 20 L22 26 L28 28 L22 30 L20 36 L18 30 L12 28 L18 26 Z" fill="currentColor"/>
                    <path d="M75 65 L77 70 L82 72 L77 74 L75 79 L73 74 L68 72 L73 70 Z" fill="currentColor"/>
                    <path d="M30 70 L31 73 L34 74 L31 75 L30 78 L29 75 L26 74 L29 73 Z" fill="currentColor"/>
                  </svg>
                  <div class="challenge-header">
                    <h3 class="challenge-title">Winter Night Out üåô</h3>
                    <span class="challenge-badge">+100 Score</span>
                  </div>
                  <p class="challenge-description">Visita 3 eventi serali invernali</p>
                  <div class="challenge-progress">
                    <div class="progress-bar-mini">
                      <div class="progress-fill-mini" [style.width]="'33%'"></div>
                    </div>
                    <span class="progress-text">1/3 completati</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Enhanced pulse score section with more attractive design -->
      <div class="pulse-score-card">
        <div class="pulse-score-header">
          <div class="pulse-icon">
            <div class="pulse-dot"></div>
            <div class="pulse-ring"></div>
            <div class="pulse-ring-2"></div>
          </div>
          <h2 class="pulse-score-title">Pulse Score</h2>
        </div>
        <p class="pulse-score-number">12,580</p>
        <div class="pulse-score-footer">
          <div class="heartbeat-line">
            <svg viewBox="0 0 200 40" class="heartbeat-svg">
              <!-- Base line always visible -->
              <path d="M0,20 L200,20" 
                    stroke="currentColor" 
                    stroke-width="5" 
                    fill="none" 
                    class="heartbeat-base-line"/>
              <!-- Moving zigzag pattern -->
              <path d="M0,20 L40,20 L45,10 L50,30 L55,5 L60,35 L65,20 L105,20" 
                    stroke="currentColor" 
                    stroke-width="5" 
                    fill="none" 
                    class="heartbeat-zigzag"/>
            </svg>
          </div>
        </div>
      </div>

      <!-- Unified Events & Invites section with tab switcher -->
      <div class="events-invites-card">
        <!-- Tab switcher at the top -->
        <div class="events-toggle">
          <div class="events-slider" [style.transform]="eventsTab === 'invites' ? 'translateX(100%)' : 'translateX(0)'"></div>
          <button class="events-button" 
                  [class.active]="eventsTab === 'countdown'"
                  (click)="eventsTab = 'countdown'">
            Countdown
          </button>
          <button class="events-button"
                  [class.active]="eventsTab === 'invites'"
                  (click)="eventsTab = 'invites'">
            Inviti
          </button>
        </div>

        <!-- Countdown content -->
        <div class="events-content" *ngIf="eventsTab === 'countdown'">
          <div class="countdown-list">
            <!-- Updated to use split card style like invites -->
            <ng-container *ngFor="let event of displayedCountdownEvents; let last = last">
              <!-- Split half-image countdown card -->
              <div class="countdown-card-split">
                <!-- Left side: Image with polygon clip -->
                <div class="countdown-image-half">
                  <div class="split-polygon-clip">
                    <img *ngIf="event.imageUrl" 
                         [src]="event.imageUrl" 
                         [alt]="event.name"
                         class="countdown-split-image">
                    <div *ngIf="!event.imageUrl" class="countdown-split-placeholder">
                      <ion-icon [name]="event.icon"></ion-icon>
                    </div>
                  </div>
                  <div class="neon-divider" [style.background]="'linear-gradient(to bottom, transparent, ' + event.countdownColor + ', transparent)'"></div>
                </div>
                
                <!-- Right side: Content -->
                <div class="countdown-content-half">
                  <p class="countdown-venue-small">{{ event.venue }}</p>
                  <h3 class="countdown-title-split">{{ event.name }}</h3>
                  <div class="countdown-time-section">
                    <span class="countdown-label-small">Starts In</span>
                    <div class="countdown-value-row">
                      <span class="countdown-number-big" [style.color]="event.countdownColor" [style.textShadow]="'0 0 15px ' + event.countdownColor">{{ event.countdownNumber }}</span>
                      <span class="countdown-unit-small">{{ event.countdownUnit }}</span>
                    </div>
                  </div>
                </div>
                
                <!-- Arrow button -->
                <button class="countdown-arrow-btn">
                  <ion-icon name="arrow-forward"></ion-icon>
                </button>
              </div>
            </ng-container>
            
            <!-- Added "View all" link when there are more than 3 events -->
            <div class="view-all-link" *ngIf="hasMoreCountdownEvents" (click)="openAllCountdownEvents()">
              <span class="view-all-text">Vedi tutti ({{ countdownEvents.length }})</span>
              <ion-icon name="chevron-forward" class="view-all-icon"></ion-icon>
            </div>
          </div>
        </div>

        <!-- Invites content -->
        <div class="events-content" *ngIf="eventsTab === 'invites'">
          <div class="invites-list">
            <!-- Updated to use displayedInvites -->
            <ng-container *ngFor="let invite of displayedInvites; let last = last">
              <!-- Split half-image invite card -->
              <div class="invite-card-split" (click)="openInviteDetail(invite.id)">
                <!-- Left side: Image with polygon clip -->
                <div class="invite-image-half">
                  <div class="split-polygon-clip">
                    <img *ngIf="invite.avatarUrl" 
                         [src]="invite.avatarUrl" 
                         [alt]="invite.eventTitle"
                         class="invite-split-image">
                    <div *ngIf="!invite.avatarUrl" class="invite-split-placeholder">
                      <span>{{ invite.avatarText || invite.eventTitle.substring(0, 2).toUpperCase() }}</span>
                    </div>
                  </div>
                  <div class="neon-divider"></div>
                </div>
                
                <!-- Right side: Content -->
                <div class="invite-content-half">
                  <h4 class="invite-from-user">{{ invite.fromUser }}</h4>
                  <h3 class="invite-title-split">{{ invite.eventTitle }}</h3>
                  <div class="invite-countdown-section">
                    <span class="countdown-label-small">Starts In</span>
                    <div class="countdown-value-row">
                      <span class="countdown-number-big" [style.color]="invite.countdownColor" [style.textShadow]="'0 0 15px ' + invite.countdownColor">{{ invite.countdownNumber }}</span>
                      <span class="countdown-unit-small">{{ invite.countdownUnit }}</span>
                    </div>
                  </div>
                </div>
                
                <!-- Arrow button -->
                <button class="invite-arrow-btn" (click)="openInviteDetail(invite.id); $event.stopPropagation()">
                  <ion-icon name="arrow-forward"></ion-icon>
                </button>
              </div>
            </ng-container>
            
            <!-- Added "View all" link when there are more than 3 invites -->
            <div class="view-all-link" *ngIf="hasMoreInvites" (click)="openAllInvites()">
              <span class="view-all-text">Vedi tutti ({{ invites.length }})</span>
              <ion-icon name="chevron-forward" class="view-all-icon"></ion-icon>
            </div>
          </div>
        </div>
      </div>

      <!-- My Groups Section -->
      <section class="my-groups-section">
        <div class="groups-header">
          <h3 class="groups-title">I Miei Gruppi</h3>
          <ion-icon name="chevron-down" class="groups-expand-icon"></ion-icon>
        </div>
        
        <!-- Search bar -->
        <div class="groups-search-bar">
          <ion-icon name="search" class="search-icon"></ion-icon>
          <input 
            type="text" 
            placeholder="Cerca i tuoi gruppi..." 
            class="groups-search-input"
            [(ngModel)]="groupSearchQuery"
          />
        </div>
        
        <!-- Groups carousel -->
        <div class="groups-carousel">
          <!-- New group card -->
          <button class="new-group-card" (click)="createNewGroup()">
            <div class="new-group-icon-wrapper">
              <ion-icon name="add" class="new-group-icon"></ion-icon>
            </div>
            <span class="new-group-text">Nuovo</span>
          </button>
          
          <!-- Existing groups -->
          <div 
            *ngFor="let group of userGroups" 
            class="group-card"
            (click)="openGroupDetail()"
          >
            <img [src]="group.coverImage" [alt]="group.name" class="group-cover-image" />
            <div class="group-overlay"></div>
            <p class="group-name">{{ group.name }}</p>
          </div>
        </div>
      </section>
    </main>
  </div>
</div>
